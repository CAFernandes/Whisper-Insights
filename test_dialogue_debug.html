<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Teste de Di√°logo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .dialogue-area {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            min-height: 200px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêõ Debug - Teste de Funcionalidade de Di√°logo</h1>

        <button class="btn" onclick="testWithRealData()">Testar com Dados Reais</button>
        <button class="btn" onclick="testWithSyntheticData()">Testar com Dados Sint√©ticos</button>
        <button class="btn" onclick="clearResults()">Limpar</button>

        <h3>üìä Dados Recebidos:</h3>
        <div id="dataResult" class="result"></div>

        <h3>üîç Debug de Parsing:</h3>
        <div id="debugResult" class="result"></div>

        <h3>üí¨ Resultado do Di√°logo:</h3>
        <div id="dialogueArea" class="dialogue-area"></div>
    </div>

    <script>
        // Copia as fun√ß√µes necess√°rias do main.js
        function formatTime(seconds) {
            if (!seconds || seconds === 0) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getSpeakerLabel(speaker) {
            const match = speaker.match(/SPEAKER_(\d+)/);
            if (match) {
                const num = parseInt(match[1]) + 1;
                return `Locutor ${num}`;
            }
            return speaker;
        }

        function parseDialogueData(data) {
            const messages = [];
            const debugInfo = [];

            try {
                debugInfo.push('=== IN√çCIO DO PARSING ===');
                debugInfo.push(`hasTranscriptionData: ${!!data.transcription_data}`);
                debugInfo.push(`hasSpeakersText: ${!!data.speakers_text}`);

                if (data.transcription_data && data.transcription_data.segments) {
                    debugInfo.push(`N√∫mero de segmentos: ${data.transcription_data.segments.length}`);

                    // Mostra os primeiros 3 segmentos como exemplo
                    debugInfo.push('\n--- PRIMEIROS 3 SEGMENTOS ---');
                    data.transcription_data.segments.slice(0, 3).forEach((segment, i) => {
                        debugInfo.push(`Segmento ${i}:`);
                        debugInfo.push(`  text: "${segment.text || 'undefined'}"`);
                        debugInfo.push(`  speaker: "${segment.speaker || 'undefined'}"`);
                        debugInfo.push(`  start: ${segment.start || 'undefined'}`);
                        debugInfo.push(`  end: ${segment.end || 'undefined'}`);
                    });

                    debugInfo.push('\n--- PROCESSAMENTO DOS SEGMENTOS ---');
                    let validSegments = 0;
                    let invalidSegments = 0;

                    data.transcription_data.segments.forEach((segment, index) => {
                        const hasText = segment.text && segment.text.trim();
                        const hasSpeaker = segment.speaker;

                        if (hasSpeaker && hasText) {
                            validSegments++;
                            messages.push({
                                speaker: segment.speaker,
                                text: segment.text.trim(),
                                start: segment.start || 0,
                                end: segment.end || 0,
                                timestamp: formatTime(segment.start || 0)
                            });
                        } else {
                            invalidSegments++;
                            if (index < 5) { // Mostra apenas os primeiros 5 inv√°lidos
                                debugInfo.push(`Segmento ${index} INV√ÅLIDO: speaker="${segment.speaker}", text="${segment.text}"`);
                            }
                        }
                    });

                    debugInfo.push(`\nSegmentos v√°lidos: ${validSegments}`);
                    debugInfo.push(`Segmentos inv√°lidos: ${invalidSegments}`);

                } else if (data.speakers_text) {
                    debugInfo.push('\n--- USANDO SPEAKERS_TEXT COMO FALLBACK ---');
                    debugInfo.push(`speakers_text: "${data.speakers_text}"`);

                    const speakersText = data.speakers_text;
                    const lines = speakersText.split('\n');

                    lines.forEach((line, index) => {
                        line = line.trim();
                        if (line) {
                            const match = line.match(/^(SPEAKER_\d+):\s*(.+)$/);
                            if (match) {
                                const speaker = match[1];
                                const text = match[2].trim();

                                if (text) {
                                    messages.push({
                                        speaker: speaker,
                                        text: text,
                                        start: 0,
                                        end: 0,
                                        timestamp: '--:--'
                                    });
                                    debugInfo.push(`Linha ${index} processada: ${speaker} -> "${text}"`);
                                }
                            } else {
                                debugInfo.push(`Linha ${index} n√£o corresponde ao padr√£o: "${line}"`);
                            }
                        }
                    });
                } else {
                    debugInfo.push('‚ùå Nenhum dado de diariza√ß√£o encontrado');
                }

                debugInfo.push(`\n=== RESULTADO FINAL ===`);
                debugInfo.push(`Total de mensagens processadas: ${messages.length}`);

            } catch (error) {
                debugInfo.push(`‚ùå ERRO: ${error.message}`);
                console.error('Erro ao processar dados de di√°logo:', error);
            }

            // Mostra o debug no elemento
            document.getElementById('debugResult').textContent = debugInfo.join('\n');

            return messages;
        }

        function renderDialogueMessages(container, messages) {
            let html = '';
            const speakerColors = ['speaker-0', 'speaker-1', 'speaker-2', 'speaker-3', 'speaker-4'];
            const speakerMap = new Map();
            let speakerIndex = 0;

            messages.forEach((message, index) => {
                if (!speakerMap.has(message.speaker)) {
                    speakerMap.set(message.speaker, speakerColors[speakerIndex % speakerColors.length]);
                    speakerIndex++;
                }

                const colorClass = speakerMap.get(message.speaker);
                const speakerLabel = getSpeakerLabel(message.speaker);

                html += `
                    <div style="margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa;">
                        <div style="font-weight: bold; margin-bottom: 5px;">
                            ${speakerLabel} - ${message.timestamp}
                        </div>
                        <div>
                            ${escapeHtml(message.text)}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<p style="color: #999;">Nenhuma mensagem para exibir</p>';
        }

        function testWithRealData() {
            fetch('/test_dialogue')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('dataResult').textContent = JSON.stringify(data, null, 2);

                    const messages = parseDialogueData(data);
                    renderDialogueMessages(document.getElementById('dialogueArea'), messages);
                })
                .catch(error => {
                    document.getElementById('dataResult').textContent = 'Erro: ' + error.message;
                    document.getElementById('debugResult').textContent = 'Erro ao buscar dados: ' + error.message;
                });
        }

        function testWithSyntheticData() {
            const syntheticData = {
                speakers_text: "SPEAKER_00: Ol√°, como voc√™ est√°?\nSPEAKER_01: Estou bem, obrigado. E voc√™?\nSPEAKER_00: Tamb√©m estou bem.\nSPEAKER_01: Que bom!",
                transcription_data: {
                    segments: [
                        {
                            speaker: "SPEAKER_00",
                            text: "Ol√°, como voc√™ est√°?",
                            start: 0.0,
                            end: 2.5
                        },
                        {
                            speaker: "SPEAKER_01",
                            text: "Estou bem, obrigado. E voc√™?",
                            start: 2.8,
                            end: 5.2
                        },
                        {
                            speaker: "SPEAKER_00",
                            text: "Tamb√©m estou bem.",
                            start: 5.5,
                            end: 7.0
                        },
                        {
                            speaker: "SPEAKER_01",
                            text: "Que bom!",
                            start: 7.3,
                            end: 8.5
                        }
                    ]
                }
            };

            document.getElementById('dataResult').textContent = JSON.stringify(syntheticData, null, 2);

            const messages = parseDialogueData(syntheticData);
            renderDialogueMessages(document.getElementById('dialogueArea'), messages);
        }

        function clearResults() {
            document.getElementById('dataResult').textContent = '';
            document.getElementById('debugResult').textContent = '';
            document.getElementById('dialogueArea').innerHTML = '';
        }
    </script>
</body>
</html>
